# 阴阳师游戏助手打包说明

## 概述

本文档记录了阴阳师游戏助手的PyInstaller打包过程，包括常见问题的解决方案。

## 项目结构

```
YYS_GameHelper/
├── build/
│   ├── build.py          # 打包脚本
│   ├── *.spec            # PyInstaller规格文件
│   └── work/             # 临时构建文件
├── core/                 # 核心模块
├── tasks/                # 任务模块
│   ├── anniversary/      # 周年庆任务
│   └── exploration/      # 探索任务
├── templates/            # 模板图片
├── dist/                 # 打包输出目录
└── config.yaml          # 配置文件
```

## 打包配置

### PyInstaller参数配置

在 `build/build.py` 中的关键配置：

```python
COMMON_PYINSTALLER_ARGS = [
    "--onefile",              # 打包成单个exe文件
    "--console",              # 启用控制台窗口（重要！）
    "--add-data", f"{CONFIG_FILE};.",
    "--add-data", f"{TEMPLATES_DIR};templates",
    # 排除不需要的模块以减小文件大小
    "--exclude-module", "torch",
    "--exclude-module", "tensorflow",
    "--exclude-module", "matplotlib",
    # 显式包含必要的模块
    "--hidden-import", "win32gui",
    "--hidden-import", "cv2",
    "--hidden-import", "numpy",
]
```

### 打包目标配置

```python
TARGETS = {
    "anniversary": {
        "name": "YYS_Anniversary",
        "entry": "tasks/anniversary/main.py",
        "description": "周年庆任务助手"
    },
    "exploration": {
        "name": "YYS_Exploration", 
        "entry": "tasks/exploration/exploration.py",
        "description": "探索任务助手"
    }
}
```

## 打包命令

### 单个任务打包

```bash
# 打包周年庆任务
python build\build.py --target anniversary --verbose

# 打包探索任务
python build\build.py --target exploration --verbose
```

### 批量打包

```bash
# 打包所有任务
python build\build.py --all --verbose
```

## 常见问题及解决方案

### 1. 程序闪退问题

**问题**: 打包后的exe文件运行时立即闪退

**原因**: 使用了 `--noconsole` 参数，导致程序无法使用 `input()` 函数

**解决方案**: 将 `--noconsole` 改为 `--console`

```python
# 错误配置
"--noconsole",

# 正确配置
"--console",
```

### 2. 模块导入错误

**问题**: `ModuleNotFoundError: No module named 'emulator'`

**原因**: 导入路径不正确

**解决方案**: 修复导入路径

```python
# 错误导入
from emulator import emulator_manager

# 正确导入
from core.emulator import emulator_manager
```

### 3. 相对导入问题

**问题**: `attempted relative import with no known parent package`

**原因**: PyInstaller打包后不支持相对导入

**解决方案**: 使用绝对导入

```python
# 错误导入
from .anniversary_task import AnniversaryTask

# 正确导入
from tasks.anniversary.anniversary_task import AnniversaryTask
```

### 4. 模板文件缺失

**问题**: `模板图片加载失败: templates\exploration\*.png`

**原因**: 模板文件没有正确复制到dist目录

**解决方案**: 手动复制模板文件

```bash
xcopy templates dist\templates /E /I /Y
```

或在打包脚本中确保 `--add-data` 参数正确：

```python
"--add-data", f"{TEMPLATES_DIR};templates",
```

### 5. 标准输入流问题

**问题**: `lost sys.stdin` 错误

**原因**: 打包后的exe文件缺少标准输入流

**解决方案**: 
1. 使用 `--console` 参数
2. 避免在打包版本中使用 `input()` 函数
3. 提供命令行参数替代交互式输入

## 打包流程

### 完整打包步骤

1. **检查代码**
   - 确保所有导入路径使用绝对导入
   - 避免使用相对导入
   - 检查模块依赖关系

2. **修改打包配置**
   - 确保使用 `--console` 参数
   - 添加必要的 `--hidden-import`
   - 配置 `--add-data` 包含资源文件

3. **执行打包**
   ```bash
   python build\build.py --target anniversary --verbose
   python build\build.py --target exploration --verbose
   ```

4. **复制资源文件**
   ```bash
   xcopy templates dist\templates /E /I /Y
   ```

5. **测试运行**
   ```bash
   dist\YYS_Anniversary.exe --help
   dist\YYS_Exploration.exe --help
   ```

### 验证清单

- [ ] exe文件能正常启动
- [ ] 显示帮助信息正常
- [ ] 模拟器检测功能正常
- [ ] 模板文件加载正常
- [ ] 交互式功能正常
- [ ] 日志系统正常

## 输出文件

打包完成后，`dist/` 目录包含：

```
dist/
├── YYS_Anniversary.exe      # 周年庆任务exe
├── YYS_Exploration.exe      # 探索任务exe
├── config.yaml              # 配置文件
├── templates/               # 模板图片目录
├── 启动_YYS_Anniversary.bat # 启动脚本
├── 启动_YYS_Exploration.bat # 启动脚本
├── README.md                # 使用说明
└── requirements.txt         # 依赖列表
```

## 注意事项

1. **控制台窗口**: 必须使用 `--console` 参数，否则无法使用交互式功能
2. **导入路径**: 统一使用绝对导入，避免相对导入
3. **资源文件**: 确保模板文件正确复制到输出目录
4. **依赖管理**: 使用 `--hidden-import` 显式包含必要模块
5. **文件大小**: 通过 `--exclude-module` 排除不需要的大型库

## 故障排除

如果遇到问题，按以下步骤排查：

1. 检查日志文件 `log/YYS_*.log`
2. 使用 `--verbose` 参数查看详细构建信息
3. 测试 `--help` 参数确认基本功能
4. 检查模板文件是否存在
5. 验证导入路径是否正确

---

*最后更新: 2025-09-13*